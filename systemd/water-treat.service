[Unit]
Description=Water-Treat RTU - Industrial Water Treatment Remote Terminal Unit
Documentation=https://github.com/mwilco03/Water-Treat
After=network.target local-fs.target
Wants=network.target

[Service]
# Type=notify means systemctl start will wait until app signals READY=1
# This ensures dependencies don't start until the app is fully initialized
Type=notify
NotifyAccess=main

ExecStart=/usr/local/bin/water-treat --daemon
ExecReload=/bin/kill -HUP $MAINPID
Restart=always
RestartSec=5

# User/Group - root needed for GPIO/I2C/SPI hardware access
User=root
Group=root
WorkingDirectory=/var/lib/water-treat

# Watchdog - set to 0 to disable, or set interval (e.g., 30s)
# Application must call sd_notify("WATCHDOG=1") periodically
# Set WatchdogSec=0 to disable watchdog entirely
WatchdogSec=30

# Logging - send stdout/stderr to journald for centralized logging
# View with: journalctl -u water-treat -f
StandardOutput=journal
StandardError=journal
SyslogIdentifier=water-treat

# Resource limits (prevent runaway processes)
MemoryMax=256M
CPUQuota=80%

# Security hardening (optional - comment out if causing issues)
ProtectSystem=strict
ReadWritePaths=/var/lib/water-treat /var/log/water-treat
ProtectHome=yes
PrivateTmp=yes
NoNewPrivileges=yes

# Hardware access
DeviceAllow=/dev/i2c-* rw
DeviceAllow=/dev/spidev* rw
DeviceAllow=/dev/gpiochip* rw
DeviceAllow=/dev/gpiomem rw
DeviceAllow=/dev/mem rw

# Environment file for configuration overrides (optional)
EnvironmentFile=-/etc/water-treat/environment

[Install]
WantedBy=multi-user.target
