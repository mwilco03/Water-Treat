#cloud-config
#
# user-data - Cloud-init configuration for Water-Treat RTU provisioning
#
# What: Bootstrap script for automated RTU deployment
# Why: Enables zero-touch provisioning of RTU devices
#
# Architecture:
#   - cloud-init: Creates user, installs git, runs provisioning
#   - runcmd: Does the actual work (clone, validate, install)
#   - Retry on reboot if network unavailable
#

hostname: rtu
locale: en_US.UTF-8
keyboard:
  layout: us
timezone: America/New_York

users:
  - name: admin
    groups: [sudo, gpio, i2c, spi, dialout]
    shell: /bin/bash
    lock_passwd: false
    sudo: ALL=(ALL) NOPASSWD:ALL

chpasswd:
  users:
    - name: admin
      password: 'H2OhYeah!'
      type: text
  expire: false

ssh_pwauth: true

package_update: true
packages:
  - git

runcmd:
  - |
    ####################################################################
    # Water-Treat RTU First Boot Provisioning
    # Non-breaking, warning-based, retry-on-reboot
    ####################################################################

    # ----- Always create required paths FIRST -----
    mkdir -p /var/log/water-treat
    mkdir -p /var/lib/water-treat
    mkdir -p /opt
    mkdir -p /home/admin

    # ----- Logging -----
    exec > >(tee -a /var/log/water-treat/first-boot.log) 2>&1
    echo "===== Provisioning attempt: $(date) ====="

    # ----- Constants -----
    STATE_DIR=/var/lib/water-treat
    INSTALL_ROOT=/opt/Water-Treat
    STAGING=/opt/.water-treat-staging
    MOTD_FILE=/etc/motd
    FAIL_COUNT_FILE=$STATE_DIR/fail.count
    MAX_FAILURES=20

    # ----- Failure Tracking -----
    get_fail_count() {
      if [ -f "$FAIL_COUNT_FILE" ]; then
        cat "$FAIL_COUNT_FILE" 2>/dev/null || echo 0
      else
        echo 0
      fi
    }

    increment_fail_count() {
      count=$(get_fail_count)
      echo $((count + 1)) > "$FAIL_COUNT_FILE"
    }

    clear_fail_count() {
      rm -f "$FAIL_COUNT_FILE"
    }

    # ----- Idempotency -----
    if [ -f "$STATE_DIR/first-boot.ok" ]; then
      echo "Provisioning already completed - exiting cleanly."
      exit 0
    fi

    # ----- Check failure threshold -----
    fail_count=$(get_fail_count)
    if [ "$fail_count" -ge "$MAX_FAILURES" ]; then
      echo "Provisioning paused after $fail_count failures"
      cat > "$MOTD_FILE" <<EOF
Water-Treat RTU

Provisioning paused after repeated failures.

To investigate:
  cat /var/log/water-treat/first-boot.log

To retry:
  rm $FAIL_COUNT_FILE
  rm $STATE_DIR/first-boot.failed
  reboot

Manual help may be needed.
EOF
      exit 0
    fi

    # ----- SSH: ensure enabled, never fatal -----
    systemctl enable ssh || true
    systemctl start ssh || true

    # ----- Hostname with MAC suffix -----
    # Priority: eth* > enp* > ens* > wlan*
    BEST_IFACE=""
    BEST_PRIORITY=0

    for iface in /sys/class/net/*; do
      [ -d "$iface" ] || continue
      name=$(basename "$iface")
      [ "$name" = "lo" ] && continue

      priority=1
      case "$name" in
        eth*)  priority=5 ;;
        enp*)  priority=4 ;;
        ens*)  priority=3 ;;
        wlan*) priority=2 ;;
      esac

      if [ "$priority" -gt "$BEST_PRIORITY" ]; then
        BEST_PRIORITY=$priority
        BEST_IFACE=$name
      fi
    done

    if [ -n "$BEST_IFACE" ]; then
      MAC_ADDR=$(cat /sys/class/net/$BEST_IFACE/address 2>/dev/null)
      if [ -n "$MAC_ADDR" ] && [ "$MAC_ADDR" != "00:00:00:00:00:00" ]; then
        # Extract last 4 hex chars (positions 12-13 and 15-16 in aa:bb:cc:dd:ee:ff)
        MAC_SUFFIX=$(echo "$MAC_ADDR" | sed 's/://g' | tail -c 5)
        MAC_SUFFIX=$(echo "$MAC_SUFFIX" | tr '[:upper:]' '[:lower:]')
      fi
    fi

    if [ -n "$MAC_SUFFIX" ]; then
      hostnamectl set-hostname "rtu-${MAC_SUFFIX}" || true
      echo "Hostname set to rtu-${MAC_SUFFIX}"
    fi

    # ----- Friendly MOTD warning (default state) -----
    cat > "$MOTD_FILE" <<'EOF'
Water-Treat RTU

Hey - we ain't been online yet.

You can still:
  - Log in
  - Configure networking
  - Inspect hardware
  - SSH into the system

Once the network is up, provisioning will automatically
retry on the next boot.

No action required if this is expected.
EOF

    # ----- Bounded network check (non-fatal) -----
    echo "Checking for network (max 60s)..."
    NET_OK=0
    for i in $(seq 1 30); do
      if getent hosts github.com >/dev/null 2>&1; then
        NET_OK=1
        break
      fi
      sleep 2
    done

    if [ "$NET_OK" -ne 1 ]; then
      echo "Network not available - deferring install"
      increment_fail_count
      touch "$STATE_DIR/first-boot.failed"
      exit 0
    fi

    # ----- Network is up: update MOTD -----
    cat > "$MOTD_FILE" <<'EOF'
Water-Treat RTU

Setting up Water-Treat RTU...

This takes a few minutes.
Progress: tail -f /var/log/water-treat/first-boot.log
EOF

    # ----- Network is up: staged install -----
    echo "Network detected - starting staged install"

    rm -rf "$STAGING"
    if ! git clone https://github.com/mwilco03/Water-Treat.git "$STAGING"; then
      echo "Git clone failed - will retry on next boot"
      increment_fail_count
      touch "$STATE_DIR/first-boot.failed"
      exit 0
    fi

    # ----- Validate clone -----
    if [ ! -f "$STAGING/scripts/install.sh" ]; then
      echo "Validation failed - will retry on next boot"
      rm -rf "$STAGING"
      increment_fail_count
      touch "$STATE_DIR/first-boot.failed"
      exit 0
    fi

    # ----- Activate atomically -----
    rm -rf "$INSTALL_ROOT"
    mv "$STAGING" "$INSTALL_ROOT"
    chown -R admin:admin "$INSTALL_ROOT"

    # ----- Install dependencies -----
    echo "Installing dependencies..."
    if ! "$INSTALL_ROOT/scripts/install-deps.sh"; then
      echo "Dependency install failed - will retry on next boot"
      increment_fail_count
      touch "$STATE_DIR/first-boot.failed"
      exit 0
    fi

    # ----- Build application (as admin, not root) -----
    echo "Building application..."
    if ! sudo -u admin "$INSTALL_ROOT/scripts/build.sh"; then
      echo "Build failed - will retry on next boot"
      increment_fail_count
      touch "$STATE_DIR/first-boot.failed"
      exit 0
    fi

    # ----- Install application -----
    echo "Installing application..."
    if ! "$INSTALL_ROOT/scripts/install.sh"; then
      echo "Install failed - will retry on next boot"
      increment_fail_count
      touch "$STATE_DIR/first-boot.failed"
      exit 0
    fi

    # ----- Enable and start service -----
    systemctl daemon-reload
    systemctl enable water-treat || true
    systemctl start water-treat || true

    # ----- Success cleanup -----
    rm -f "$STATE_DIR/first-boot.failed"
    clear_fail_count
    touch "$STATE_DIR/first-boot.ok"
    touch /home/admin/.cloud-init-complete
    chown admin:admin /home/admin/.cloud-init-complete

    # ----- Final MOTD -----
    HOSTNAME=$(hostname)
    cat > "$MOTD_FILE" <<EOF
Water-Treat RTU: $HOSTNAME
Provisioned: $(date '+%Y-%m-%d %H:%M')

Service commands:
  systemctl status water-treat
  systemctl restart water-treat
  journalctl -u water-treat -f

Source: $INSTALL_ROOT
EOF

    echo "===== Provisioning completed successfully ====="

final_message: |
  Water-Treat RTU provisioning attempted.

  If networking was unavailable, provisioning will retry
  automatically on the next boot.

  Logs:
    /var/log/water-treat/first-boot.log
