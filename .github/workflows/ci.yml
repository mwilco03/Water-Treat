# ============================================================
# CI Workflow - Continuous Integration
# ============================================================
# Triggers: Push to main/develop, Pull Requests, Manual dispatch
# Builds: x86_64 (native), aarch64, armv7hf (cross-compile, optional)
# Tests: Native x86_64 only (cross-compiled binaries cannot be tested)
# Quality: Static analysis (cppcheck), format checking (clang-format)
# ============================================================
name: CI

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      include_cross_builds:
        description: 'Include ARM cross-compilation builds'
        type: boolean
        default: true

jobs:
  # ============================================================
  # Build Job - Uses reusable workflow
  # ============================================================
  build:
    uses: ./.github/workflows/build.yml
    with:
      build_type: 'Release'
      run_tests: true
      upload_artifacts: true
      artifact_retention_days: 7
      include_cross_builds: ${{ github.event.inputs.include_cross_builds != 'false' }}

  # ============================================================
  # Static Analysis - Advisory (non-blocking)
  # ============================================================
  static-analysis:
    runs-on: ubuntu-latest
    continue-on-error: true  # Advisory, doesn't block CI

    steps:
      - uses: actions/checkout@v4

      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: cppcheck
          version: 1.0-cppcheck

      - name: Run cppcheck
        run: |
          cppcheck --version
          cppcheck \
            --enable=warning,style,performance,portability \
            --suppress=missingIncludeSystem \
            --error-exitcode=0 \
            --inline-suppr \
            --quiet \
            -I include -I src \
            src/ 2>&1 | tee cppcheck-report.txt

          # Show summary
          echo "=== Static Analysis Summary ==="
          if grep -q "error:" cppcheck-report.txt; then
            echo "⚠️  Errors found (review recommended)"
            grep "error:" cppcheck-report.txt | head -10
          else
            echo "✅ No errors found"
          fi

      - name: Upload cppcheck report
        uses: actions/upload-artifact@v4
        with:
          name: cppcheck-report
          path: cppcheck-report.txt
          retention-days: 30

  # ============================================================
  # Format Check - Advisory (non-blocking)
  # ============================================================
  format-check:
    runs-on: ubuntu-latest
    continue-on-error: true  # Advisory, doesn't block CI

    steps:
      - uses: actions/checkout@v4

      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: clang-format
          version: 1.0-clang-format

      - name: Check code formatting
        run: |
          echo "=== Code Formatting Check ==="
          UNFORMATTED=$(find src include -name '*.c' -o -name '*.h' 2>/dev/null | head -50 | \
            xargs -I {} sh -c 'clang-format --dry-run --Werror {} 2>&1' | grep -c "error:" || true)

          if [ "$UNFORMATTED" -gt 0 ]; then
            echo "⚠️  $UNFORMATTED file(s) need formatting"
            echo "Run: find src include -name '*.c' -o -name '*.h' | xargs clang-format -i"
          else
            echo "✅ All files properly formatted"
          fi

  # ============================================================
  # CI Summary
  # ============================================================
  ci-summary:
    runs-on: ubuntu-latest
    needs: [build, static-analysis, format-check]
    if: always()

    steps:
      - name: CI Summary
        run: |
          echo "=== CI Summary ==="
          echo "Build: ${{ needs.build.result }}"
          echo "Static Analysis: ${{ needs.static-analysis.result }}"
          echo "Format Check: ${{ needs.format-check.result }}"

          if [ "${{ needs.build.result }}" = "failure" ]; then
            echo "❌ CI failed: Build errors"
            exit 1
          fi

          echo "✅ CI passed"
